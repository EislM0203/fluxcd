# extra vars: tailscale_preauth_key: "f9f69ab96f09e7f46a049e00a30edb56e9ad6df74a7b8f5f"
---
- name: Install and Configure Tailscale
  hosts: proxmox
  become: yes
  gather_facts: yes
  
  vars:
    tailscale_login_server: "https://headscale.lighthouse.traunseenet.com"
    tailscale_preauth_key: "{{ tailscale_preauth_key }}"
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
    
    - name: Install required packages
      apt:
        name:
          - curl
          - gnupg
        state: present
    
    - name: Create keyrings directory
      file:
        path: /usr/share/keyrings
        state: directory
        mode: '0755'
    
    - name: Download Tailscale GPG key
      shell: |
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
      args:
        creates: /usr/share/keyrings/tailscale-archive-keyring.gpg
    
    - name: Add Tailscale repository
      shell: |
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | tee /etc/apt/sources.list.d/tailscale.list
      args:
        creates: /etc/apt/sources.list.d/tailscale.list
    
    - name: Update apt cache after adding Tailscale repo
      apt:
        update_cache: yes
    
    - name: Install Tailscale
      apt:
        name: tailscale
        state: present
    
    - name: Connect to Tailscale network
      command: >
        tailscale up
        --login-server={{ tailscale_login_server }}
        --authkey={{ tailscale_preauth_key }}