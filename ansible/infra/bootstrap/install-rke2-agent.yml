- name: Install RKE2 Kubernetes Agent Nodes
  hosts: rke2_agents
  become: yes
  vars:
    rke2_version: "latest"
    rke2_server_url: "https://{{ hostvars[groups['rke2_server'][0]]['ansible_host'] }}:9345"
    rke2_token: "{{ rke2_node_token }}"
    
  tasks:
    - name: Get RKE2 node token from server
      shell: sudo cat /var/lib/rancher/rke2/server/node-token
      register: rke2_node_token_result
      delegate_to: "{{ groups['rke2_server'][0] }}"
      run_once: true
      changed_when: false
      
    - name: Set RKE2 node token fact
      set_fact:
        rke2_node_token: "{{ rke2_node_token_result.stdout.strip() }}"
      run_once: true

    - name: Create RKE2 config directory
      file:
        path: /etc/rancher/rke2
        state: directory
        mode: '0755'

    - name: Download and install RKE2 agent
      shell: |
        curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="agent" sh -
      args:
        creates: /usr/local/bin/rke2

    - name: Create RKE2 config for agent
      copy:
        content: |
          server: {{ rke2_server_url }}
          token: {{ rke2_token }}
          node-ip: "{{ ansible_host }}"
        dest: /etc/rancher/rke2/config.yaml
        mode: '0640'

    - name: Enable and start RKE2 agent
      systemd:
        name: rke2-agent.service
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Wait for agent to connect to server
      wait_for:
        host: "{{ rke2_server_url.split('://')[1].split(':')[0] }}"
        port: 9345
        timeout: 300

    - name: Display agent status
      systemd:
        name: rke2-agent.service
      register: agent_status
      
    - name: Show agent service status
      debug:
        msg: "RKE2 Agent Status: {{ agent_status.status.ActiveState }}"