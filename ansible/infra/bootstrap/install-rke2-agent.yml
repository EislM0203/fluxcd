- name: Install RKE2 Kubernetes Agent Nodes
  hosts: proxmox
  become: yes
  vars:
    rke2_version: "latest"
    rke2_server_url: "https://{{ server_tailscale_ip }}:9345"
    rke2_token: "{{ rke2_node_token }}"
    
  tasks:
    - name: Get Tailscale IP from RKE2 server
      shell: tailscale ip -4
      register: server_tailscale_ip_result
      delegate_to: "{{ groups['hetzner'][0] }}"
      run_once: true
      changed_when: false
      
    - name: Set server Tailscale IP fact
      set_fact:
        server_tailscale_ip: "{{ server_tailscale_ip_result.stdout.strip() }}"
      run_once: true
      
    - name: Get RKE2 node token from server
      shell: sudo cat /var/lib/rancher/rke2/server/node-token
      register: rke2_node_token_result
      delegate_to: "{{ groups['hetzner'][0] }}"
      run_once: true
      changed_when: false
      
    - name: Set RKE2 node token fact
      set_fact:
        rke2_node_token: "{{ rke2_node_token_result.stdout.strip() }}"
      run_once: true

    - name: Get Tailscale IP address for each node
      shell: tailscale ip -4
      register: tailscale_ip_result
      changed_when: false
      
    - name: Set tailscale_ip fact
      set_fact:
        tailscale_ip: "{{ tailscale_ip_result.stdout.strip() }}"
        
    - name: Display node information
      debug:
        msg: "Agent node {{ inventory_hostname }} has Tailscale IP: {{ tailscale_ip }}"

    - name: Create RKE2 config directory
      file:
        path: /etc/rancher/rke2
        state: directory
        mode: '0755'

    - name: Download and install RKE2 agent
      shell: |
        curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="agent" sh -
      args:
        creates: /usr/local/bin/rke2

    - name: Create RKE2 config for agent
      copy:
        content: |
          server: {{ rke2_server_url }}
          token: {{ rke2_token }}
          node-ip: "{{ tailscale_ip }}"
        dest: /etc/rancher/rke2/config.yaml
        mode: '0640'

    - name: Enable and start RKE2 agent
      systemd:
        name: rke2-agent.service
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Wait for agent to connect to server
      wait_for:
        host: "{{ rke2_server_url.split('://')[1].split(':')[0] }}"
        port: 9345
        timeout: 300

    - name: Display agent status
      systemd:
        name: rke2-agent.service
      register: agent_status
      
    - name: Show agent service status
      debug:
        msg: "RKE2 Agent Status: {{ agent_status.status.ActiveState }}"

    - name: Display installation completion message
      debug:
        msg: |
          RKE2 Agent installation completed on {{ inventory_hostname }}
          - Agent is connecting to: {{ rke2_server_url }}
          - Node IP: {{ tailscale_ip }}
          - Service status: {{ agent_status.status.ActiveState }}
          
          To verify the node joined the cluster, run on the server:
          sudo /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml get nodes
